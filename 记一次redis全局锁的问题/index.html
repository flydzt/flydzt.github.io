<!doctype html>
<html lang="en">
    <head>
		
        <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="解决一类问题而不是一个问题">
        <link rel="shortcut icon" href="/images/hhh.jpg"/>
        <link rel="canonical" href="http://guolinn.com/">
        <link rel="alternate" type="application/rss+xml" title="flydzt" href="">
        <title>记一次redis全局锁的问题 | flydzt</title>
        <meta name="description" content="{{meta_description}}">

        <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/styles/crisp.css">
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

    <meta name="generator" content="Hexo 4.2.0"></head>
    
		<body class="post-template">
	

        <header id="header">
            <a id="logo" href="/"><img src="/images/hhh.jpg" alt="flydzt" /></a>
            <h1><a href="/">flydzt</a></h1>
            <p></p>
            <div id="follow-icons">
          <a href="http://github.com/flydzt" target="_blank" rel="noopener"><i class="fa fa-github-square fa-2x"></i></a>
          </div>
<h6><a href="/about">About</a></h6>
        </header>

        <main id="content">
        

<article class="post">
  四月 25, 2020
  
    <span class="taglist">  &middot; 
    
    
      <a href='/tags/java/'>java</a> 
    
      <a href='/tags/redis/'>redis</a> 
    
    </span>
  

  <h1 class="post-title">记一次redis全局锁的问题</h1>
  <section class="post-content article-entry">
    <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在一个刷新数据的任务里,防止多个节点同时开始任务浪费资源,使用redis作为全局锁.</p>
<p>多个节点使用set nx lock来获取锁,没有获取到将退出,等待下一次调度.任务结束后将锁del.</p>
<p>任务的触发周期为1分钟.</p>
<p>任务过程为: 从数据库捞出一批数据,通过hmset设置数据到一个tempKey中,捞出多批后结束.将tempKey rename为正式key.</p>
<p>redis在cluster模式下,rename操作需要保证两个key在同一个slot里.tempKey是通过一个循环算出来的.</p>
<p>为了防止进程意外退出锁不能释放,使用set nx lock ex 60来做过期.</p>
<p>如果进程挂掉,过了一段时间重启,tempKey的数据不是最新的,是需要被删掉的.</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>这个任务已经跑了很久,最近由于数据量的增长,任务耗时变久了.</p>
<p>于是出现了任务没有跑完,锁被释放的情况.</p>
<p>而另一个节点,获取到了锁,并发现tempKey存在,于是删除了.</p>
<p>而本节点的任务还没跑完,tempKey已经被hmset的数据丢失了.</p>
<p>接着两个节点一起往这个tempKey里写数据,最后rename替换正式key.</p>
<p>之后另一个节点还在往tempKey里写数据,写完后又rename了一次.</p>
<p>导致最后的正式key数据不完整.不完整程度和任务耗时有关.</p>
<h2 id="临时解决"><a href="#临时解决" class="headerlink" title="临时解决"></a>临时解决</h2><p>耗时增长了,需要改变触发周期和锁的时间.增加到2分钟.</p>
<p>其次,防止tempKey被别的节点删除的情况,将ip地址作为tempKey的一部分,这样每个节点只会操作一个tempKey.</p>
<p>即使两个任务同时进行,能保证各自的tempKey的数据完整性.</p>
<h2 id="长期方案"><a href="#长期方案" class="headerlink" title="长期方案"></a>长期方案</h2><p>使用elastic job来做任务调度,而不是靠每个节点去获取锁的方式.</p>

  </section>
  <footer class="post-footer">
    <!--
    <section class="author">
      <h4>flydzt</h4>
      <p></p>
    </section>
    -->
  </footer>
</article>

<nav class="pagination" role="pagination">
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/dubbo%E7%9A%84%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E4%BB%A5%E5%8F%8A%E4%BC%98%E5%85%88%E7%BA%A7/">
        <!--dubbo的配置优先级--> next →
    </a>
    
</nav>


        </main>
        <footer id="footer">
            <section id="footer-message">&copy; 2020 flydzt. </section>
        </footer>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>


